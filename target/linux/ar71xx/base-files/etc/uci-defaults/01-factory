#!/bin/sh

change_default_network() {
	local distname=$1

	case $distname in
		EZR13)
			local ret=$(uci -q get network.MOBILE)
			[ "$ret" == "interface" ] && {
				uci delete network.MOBILE
				uci set network.lan.ifname=eth0
				uci set network.lan.ipaddr="192.168.10.1"
				uci set network.wan.ifname=eth1
				uci delete mwan3.MOBILE
				uci delete mwan3.MOBILE_m
				uci delete mwan3.4G_only
				uci delete mwan3.ALL
				uci set system.@system[0].hostname=OutdoorExtender
				uci commit system
				uci commit network
				uci commit mwan3
			}
			;;
		EZR23)
			local firstboot=$(uci -q get system.@system[0].firstboot)
			[ -z "$firstboot" ] && {
				uci set network.lan.ipaddr="192.168.20.1"
				uci set system.@system[0].hostname=CellularRouter
				uci set system.@system[0].firstboot=1
				uci commit network
				uci commit system
			}
			;;
	esac
}


distname=$(grep DISTRIB_ID /etc/openwrt_release | awk -F= '{print $2}' | sed s/\'//g)

serial_number=$(fw_printenv serial_number|awk -F= '{print $2}')

[ "y$serial_number" == "y" ] && {
	local mac=$(ip link show eth0 | grep ether | awk '{ print $2 }' | sed s/\://g)
	local random=$(head -n 10 /dev/urandom | md5sum )
	random=$(echo ${random:0:4})
	serial_number=ES${random}${mac:8:12}
	serial_number=$(echo $serial_number | tr 'a-z' 'A-Z')
	fw_setenv serial_number $serial_number
}

uci set productinfo.hardware.serial_number=$serial_number
uci set productinfo.hardware.product_name=$distname
uci commit productinfo


change_default_network "$distname"

exit 0
